---
title: 10个常见的Redis面试"刁难"问题
date: 2018-07-25 07:31:07
tags: [redis, 面试, 问题]
categories: 其他
---

> 导读：在程序员面试过程中Redis相关的知识是常被问到的话题。作为一名在互联网技术行业打击过成百上千名的资深技术面试官，本文作者总结了面试过程中经常问到的问题。十分值得一读。

> 作者简介：钱文品（老钱），互联网分布式高并发技术十年老兵，目前任掌阅科技资深后端工程师。熟练使用 Java、Python、Golang 等多种计算机语言，开发过游戏，制作过网站，写过消息推送系统和MySQL 中间件，实现过开源的 ORM 框架、Web 框架、RPC 框架等

`Redis`在互联网技术存储方面使用如此广泛，几乎所有的后端技术面试官都要在`Redis`的使用和原理方面对小伙伴们进行各种刁难。作为一名在互联网技术行业打击过成百上千名【请允许我夸张一下】的资深技术面试官，看过了无数落寞的身影失望的离开，略感愧疚，故献上此文，希望各位读者以后面试势如破竹，永无失败！

<!--more-->

# Redis有哪些数据结构？

`字符串String`、`字典Hash`、`列表List`、`集合Set`、`有序集合SortedSet`。

如果你是Redis中高级用户，还需要加上下面几种数据结构`HyperLogLog`、`Geo`、`Pub/Sub`。

如果你说还玩过`Redis Module`，像`BloomFilter`，`RedisSearch`，`Redis-ML`，面试官得眼睛就开始发亮了。

# 使用过Redis分布式锁么，它是什么回事？

先拿`setnx`来争抢锁，抢到之后，再用`expire`给锁加一个过期时间防止锁忘记了释放。

这时候对方会告诉你说你回答得不错，然后接着问如果在`setnx`之后执行`expire`之前进程意外crash或者要重启维护了，那会怎么样？

这时候你要给予惊讶的反馈：唉，是喔，这个锁就永远得不到释放了。紧接着你需要抓一抓自己得脑袋，故作思考片刻，好像接下来的结果是你主动思考出来的，然后回答：我记得`set`指令有非常复杂的参数，这个应该是可以同时把`setnx`和`expire`合成一条指令来用的！对方这时会显露笑容，心里开始默念：摁，这小子还不错。

# 假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？

使用keys指令可以扫出指定模式的key列表。

对方接着追问：如果这个`redis`正在给线上的业务提供服务，那使用keys指令会有什么问题？

这个时候你要回答`redis`关键的一个特性：`redis`的单线程的。keys指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用`scan`指令，`scan`指令可以无阻塞的提取出指定模式的key列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用`keys`指令长。

# 使用过Redis做异步队列么，你是怎么用的？

一般使用`list`结构作为队列，`rpush`生产消息，`lpop`消费消息。当`lpop`没有消息的时候，要适当`sleep`一会再重试。

如果对方追问可不可以不用`sleep`呢？`list`还有个指令叫`blpop`，在没有消息的时候，它会阻塞住直到消息到来。

如果对方追问能不能生产一次消费多次呢？使用`pub`/`sub`主题订阅者模式，可以实现`1:N`的消息队列。

如果对方追问`pub`/`sub`有什么缺点？在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如`rabbitmq`等。

如果对方追问`redis`如何实现延时队列？我估计现在你很想把面试官一棒打死如果你手上有一根棒球棍的话，怎么问的这么详细。但是你很克制，然后神态自若的回答道：使用`sortedset`，拿时间戳作为`score`，消息内容作为`key`调用`zadd`来生产消息，消费者用`zrangebyscore`指令获取N秒之前的数据轮询进行处理。

到这里，面试官暗地里已经对你竖起了大拇指。但是他不知道的是此刻你却竖起了中指，在椅子背后。

# 如果有大量的key需要设置同一时间过期，一般需要注意什么？

如果大量的`key`过期时间设置的过于集中，到过期的那个时间点，redis可能会出现短暂的卡顿现象。一般需要在时间上加一个随机值，使得过期时间分散一些。

# Redis如何做持久化的？

`bgsave`做镜像全量持久化，`aof`做增量持久化。因为`bgsave`会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要`aof`来配合使用。在`redis`实例重启时，优先使用`aof`来恢复内存的状态，如果没有`aof`日志，就会使用`rdb`文件来恢复。

如果再问`aof`文件过大恢复时间过长怎么办？你告诉面试官，`Redis`会定期做`aof`重写，压缩`aof`文件日志大小。如果面试官不够满意，再拿出杀手锏答案，`Redis4.0`之后有了混合持久化的功能，将`bgsave`的全量和`aof`的增量做了融合处理，这样既保证了恢复的效率又兼顾了数据的安全性。这个功能甚至很多面试官都不知道，他们肯定会对你刮目相看。

如果对方追问那如果突然机器掉电会怎样？取决于`aof`日志`sync`属性的配置，如果不要求性能，在每条写指令时都`sync`一下磁盘，就不会丢失数据。但是在高性能的要求下每次都`sync`是不现实的，一般都使用定时`sync`，比如`1s1次`，这个时候最多就会丢失1s的数据。

# Pipeline有什么好处，为什么要用pipeline？

可以将多次IO往返的时间缩减为一次，前提是`pipeline`执行的指令之间没有因果相关性。使用`redis-benchmark`进行压测的时候可以发现影响`redis`的`QPS`峰值的一个重要因素是`pipeline`批次指令的数目。

# Redis的同步机制了解么？

`Redis`可以使用主从同步，从从同步。第一次同步时，主节点做一次`bgsave`，并同时将后续修改操作记录到内存`buffer`，待完成后将`rdb`文件全量同步到复制节点，复制节点接受完成后将`rdb`镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。

# 是否使用过Redis集群，集群的原理是什么？

`Redis Sentinal`着眼于高可用，在`master`宕机时会自动将`slave`提升为`master`，继续提供服务。

`Redis Cluster`着眼于扩展性，在单个`redis`内存不足时，使用`Cluster`进行分片存储。

原文：[10个常见的Redis面试"刁难"问题](https://mp.weixin.qq.com/s/Z4a8wbWvPDGFTkKJH0X9VQ)